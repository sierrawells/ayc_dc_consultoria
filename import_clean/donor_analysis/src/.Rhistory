drive_download(as_id(id_orgs_w_ntee),
path = paste0(tempdir(), "/orgs_w_ntee_2024.csv"),
overwrite = TRUE)
orgs_w_ntee <- read_csv(paste0(tempdir(), "/orgs_w_ntee_2024.csv"))
file.remove(paste0(tempdir(), "/orgs_w_ntee_2024.csv"))
ntee_to_movements <- read_csv(paste0(tempdir(), "/ntee_to_movements_2024.csv"))
View(ntee_to_movements)
ntee_to_movements <- read_csv(paste0(tempdir(), "/ntee_to_movements_2024.csv")) %>%
select(ntee_code:second_classification)
View(ntee_to_movements)
file.remove(paste0(tempdir(), "/ntee_to_movements_2024.csv"))
orgs_w_second_classification <- orgs_w_ntee %>%
left_join(ntee_to_movements, by = c("ntee","ntee_code"))
orgs_w_second_classification <- orgs_w_ntee %>%
left_join(ntee_to_movements, by = c("ntee" = "ntee_code"))
View(orgs_w_second_classification)
# JOIN DATA ====
orgs_w_second_classification <- orgs_w_ntee %>%
left_join(ntee_to_movements, by = c("ntee" = "ntee_code")) %>%
left_join(misiones, by = "rfc")
View(orgs_w_second_classification)
orgs_w_second_classification <- orgs_w_ntee %>%
left_join(ntee_to_movements, by = c("ntee" = "ntee_code")) %>%
left_join(misiones, by = "rfc") %>%
relocate(c(razon_social, mision, valores), .after = rfc)
View(orgs_w_second_classification)
# JOIN DATA ====
orgs_w_second_classification <- orgs_w_ntee %>%
left_join(ntee_to_movements, by = c("ntee" = "ntee_code")) %>%
left_join(misiones, by = "rfc") %>%
relocate(c(razon_social, mision, valores), .after = rfc) %>%
select(rfc:valores, ntee, second_classification)
View(orgs_w_second_classification)
any(startsWith(orgs_w_second_classification$ntee, "Z"))
non_movements <- orgs_w_second_classification %>%
filter(second_classification != "Clasificar movimiento")
View(non_movements)
movements_to_classify <- orgs_w_second_classification %>%
filter(second_classification == "Clasificar movimiento")
View(movements_to_classify)
movements_training_data <- movements_to_classify %>%
slice_sample(n = 20)
movements_to_classify_pre <- orgs_w_second_classification %>%
filter(second_classification == "Clasificar movimiento")
movements_to_classify <- movements_to_classify_pre %>%
filter(!rfc %in% movements_training_data$rfc)
stopifnot(nrow(movements_to_classify) + nrow(movements_training_data) == nrow(movements_to_classify_pre))
5411/6
# To be classified
# Divide movements_to_classify into n parts and save each part
n <- 12
chunk_size <- trunc(nrow(movements_to_classify) / n)
for (i in 1:n){
start_row <- ((i - 1) * chunk_size) + 1
end_row <- ifelse(i == n, nrow(movements_to_classify), i * chunk_size)
movements_to_classify_part <- movements_to_classify %>%
slice(start_row:end_row)
stopifnot(nrow(movements_to_classify_part) >= chunk_size)
write_csv(movements_to_classify_part,
paste0(paths$output, "movements_to_classify_part_", i, ".csv"))
drive_upload(paste0(paths$output, "movements_to_classify_part_", i, ".csv"),
path = drive_out,
overwrite = TRUE)
file.remove(paste0(paths$output, "movements_to_classify_part_", i, ".csv"))
}
# Training data
write_csv(movements_training_data,
paste0(paths$output, "movements_training_data.csv"))
drive_upload(paste0(paths$output, "movements_training_data.csv"),
path = drive_out,
overwrite = TRUE)
file.remove(paste0(paths$output, "movements_training_data.csv"))
glimpse(movements_to_classify_pre)
movements_to_classify_pre <- orgs_w_second_classification %>%
filter(second_classification == "Clasificar movimiento") %>%
select(-second_classification)
movements_training_data <- movements_to_classify %>%
slice_sample(n = 20)
movements_to_classify <- movements_to_classify_pre %>%
filter(!rfc %in% movements_training_data$rfc)
stopifnot(nrow(movements_to_classify) + nrow(movements_training_data) == nrow(movements_to_classify_pre))
movements_to_classify_pre <- orgs_w_second_classification %>%
filter(second_classification == "Clasificar movimiento") %>%
select(-second_classification)
movements_to_classify_pre
movements_to_classify_pre <- orgs_w_second_classification %>%
filter(second_classification == "Clasificar movimiento") %>%
select(-second_classification)
movements_training_data <- movements_to_classify %>%
slice_sample(n = 20)
movements_to_classify <- movements_to_classify_pre %>%
filter(!rfc %in% movements_training_data$rfc)
stopifnot(nrow(movements_to_classify) + nrow(movements_training_data) == nrow(movements_to_classify_pre))
# Training data
write_csv(movements_training_data,
paste0(paths$output, "movements_training_data.csv"))
drive_upload(paste0(paths$output, "movements_training_data.csv"),
path = drive_out,
overwrite = TRUE)
file.remove(paste0(paths$output, "movements_training_data.csv"))
# To be classified
# Divide movements_to_classify into n parts and save each part
n <- 12
chunk_size <- trunc(nrow(movements_to_classify) / n)
for (i in 1:n){
start_row <- ((i - 1) * chunk_size) + 1
end_row <- ifelse(i == n, nrow(movements_to_classify), i * chunk_size)
movements_to_classify_part <- movements_to_classify %>%
slice(start_row:end_row)
stopifnot(nrow(movements_to_classify_part) >= chunk_size)
write_csv(movements_to_classify_part,
paste0(paths$output, "movements_to_classify_part_", i, ".csv"))
drive_upload(paste0(paths$output, "movements_to_classify_part_", i, ".csv"),
path = drive_out,
overwrite = TRUE)
file.remove(paste0(paths$output, "movements_to_classify_part_", i, ".csv"))
}
movements_to_classify_pre <- orgs_w_second_classification %>%
filter(second_classification == "Clasificar movimiento",
!is.na(mision)) %>%
select(-second_classification)
movements_training_data <- movements_to_classify %>%
slice_sample(n = 20)
movements_to_classify <- movements_to_classify_pre %>%
filter(!rfc %in% movements_training_data$rfc)
stopifnot(nrow(movements_to_classify) + nrow(movements_training_data) == nrow(movements_to_classify_pre))
movements_to_classify_pre <- orgs_w_second_classification %>%
filter(second_classification == "Clasificar movimiento",
!is.na(mision)) %>%
select(-second_classification)
movements_training_data <- movements_to_classify %>%
slice_sample(n = 20)
movements_to_classify <- movements_to_classify_pre %>%
filter(!rfc %in% movements_training_data$rfc)
stopifnot(nrow(movements_to_classify) + nrow(movements_training_data) == nrow(movements_to_classify_pre))
# To be classified
# Divide movements_to_classify into n parts and save each part
n <- 12
chunk_size <- trunc(nrow(movements_to_classify) / n)
for (i in 1:n){
start_row <- ((i - 1) * chunk_size) + 1
end_row <- ifelse(i == n, nrow(movements_to_classify), i * chunk_size)
movements_to_classify_part <- movements_to_classify %>%
slice(start_row:end_row)
stopifnot(nrow(movements_to_classify_part) >= chunk_size)
write_csv(movements_to_classify_part,
paste0(paths$output, "movements_to_classify_part_", i, ".csv"))
drive_upload(paste0(paths$output, "movements_to_classify_part_", i, ".csv"),
path = drive_out,
overwrite = TRUE)
file.remove(paste0(paths$output, "movements_to_classify_part_", i, ".csv"))
}
# Training data
write_csv(movements_training_data,
paste0(paths$output, "movements_training_data.csv"))
drive_upload(paste0(paths$output, "movements_training_data.csv"),
path = drive_out,
overwrite = TRUE)
file.remove(paste0(paths$output, "movements_training_data.csv"))
View(orgs_w_ntee)
test <- orgs_w_ntee %>% filter(length(ntee) != 3)
View(test)
test <- orgs_w_ntee %>% filter(nchar(ntee) != 3)
View(misiones)
#
# Author: SW
# Maintainer(s): SW, PB, IS
# License:  Data Cívica 2025 ©
# ---------------------------------------------
# Packages
if(!require(pacman)) install.packages("pacman")
pacman::p_load(tidyverse, here, googledrive)
# Files ====
drive_auth(email = "sierra.wells@datacivica.org")
# Previously classified NTEE codes (AyC)
id_ayc_class <- drive_ls(as_id("1K6ebrM6DPQR9aUTwD6PiSw9fWuvCeYhn")) %>%
filter(name == "ntee_already_classified.csv") %>%
pull(id)
# Predicted NTEE codes (Gemini)
df_gemini_class <- drive_ls(as_id("16CVo8XsSrjyMQyoS2g5R-yPIQhV5nGjm")) %>%
filter(startsWith(name, "ntee_predicted_"))
stopifnot(nrow(df_gemini_class) == 13)
# Reclassified NTEE codes (Gemini)
df_gemini_reclass <- drive_ls(as_id("16CVo8XsSrjyMQyoS2g5R-yPIQhV5nGjm")) %>%
filter(startsWith(name, "ntee_reclassified_"))
stopifnot(nrow(df_gemini_reclass) == 3)
# Drive for output
drive_out <- as_id("16CVo8XsSrjyMQyoS2g5R-yPIQhV5nGjm")
# READ DATA ====
# Previously classified NTEE codes (AyC)
drive_download(id_ayc_class,
path = paste0(tempdir(), "/ntee_ayc.csv"),
overwrite = TRUE)
ntee_ayc <- read_csv(paste0(tempdir(), "/ntee_ayc.csv")) %>%
mutate(tipo_clasificacion_ntee = "AyC")
file.remove(paste0(tempdir(), "/ntee_ayc.csv"))
# Predicted NTEE codes (Gemini)
# TODOS: REDO PART 6: MISSION ROWS
chunk_size <- 282
ntee_gemini_ls <- list()
for (row_num in 1:nrow(df_gemini_class)){
part_num <- str_extract(df_gemini_class$name[row_num], "\\d+")
id <- df_gemini_class$id[row_num]
drive_download(id,
path = paste0(tempdir(), "ntee_gemini_", part_num, ".csv"),
overwrite = TRUE)
tempo <- read_csv(paste0(tempdir(), "ntee_gemini_", part_num, ".csv"))
if (!is.na(part_num)) stopifnot(nrow(tempo) >= chunk_size)
ntee_gemini_ls[[part_num]] <- tempo %>%
mutate(tipo_clasificacion_ntee = "Gemini") %>%
filter(!is.na(mision),
ntee != "Z99")
}
# Reclassified NTEE codes (Gemini)
ntee_gemini_reclass_ls <- list()
for (row_num in 1:nrow(df_gemini_reclass)){
part_num <- str_extract(df_gemini_reclass$name[row_num], "\\d+")
id <- df_gemini_reclass$id[row_num]
drive_download(id,
path = paste0(tempdir(), "ntee_gemini_reclass_", part_num, ".csv"),
overwrite = TRUE)
tempo <- read_csv(paste0(tempdir(), "ntee_gemini_reclass_", part_num, ".csv"))
stopifnot(nrow(tempo) == 200)
ntee_gemini_reclass_ls[[part_num]] <- tempo %>%
mutate(tipo_clasificacion_ntee = "Gemini") %>%
filter(!is.na(mision),
ntee != "Z99")
}
# JOIN DATA ====
ntee_joined <- ntee_ayc %>%
bind_rows(bind_rows(ntee_gemini_ls)) %>%
bind_rows(bind_rows(ntee_gemini_reclass_ls)) %>%
select(rfc:tipo_clasificacion_ntee) %>%
group_by(rfc) %>%
reframe(
multiple_codes = length(unique(ntee)) > 1,
ntee = ifelse(multiple_codes,
ntee[tipo_clasificacion_ntee == "Gemini"],
unique(ntee)),
tipo_clasificacion_ntee = ifelse(multiple_codes,
"Gemini",
tipo_clasificacion_ntee)) %>%
select(-multiple_codes)
stopifnot(length(unique(ntee_joined$rfc)) == nrow(ntee_joined))
View(ntee_joined)
# EXPORT DATA ====
write_csv(ntee_joined,
paste0(tempdir(), "/ntee_classified_joined.csv"))
drive_upload(paste0(tempdir(), "/ntee_classified_joined.csv"),
path = drive_out,
overwrite = TRUE)
file.remove(paste0(tempdir(), "/ntee_classified_joined.csv"))
id_training_data <- drive_ls(drive_out) %>%
filter(name == "movements_training_data") %>%
pull(id)
drive_ls(drive_out)
drive_out <- as_id("1K6ebrM6DPQR9aUTwD6PiSw9fWuvCeYhn")
rm(list = ls())
#
# Author: SW
# Maintainer(s): SW, AF, PB, IS
# License:  Data Cívica 2025 ©
# ---------------------------------------------
# TODO
# Packages
if(!require(pacman)) install.packages("pacman")
pacman::p_load(tidyverse, here, janitor, googledrive, readxl)
# Files
paths <- list(output = here("donor_analysis/import_clean/output/"))
drive_auth(email = "sierra.wells@datacivica.org")
drive_out <- as_id("1K6ebrM6DPQR9aUTwD6PiSw9fWuvCeYhn")
id_orgs_w_ntee <- drive_ls(as_id("16CVo8XsSrjyMQyoS2g5R-yPIQhV5nGjm")) %>%
filter(name == "ntee_classified_joined.csv") %>%
pull(id)
id_mision <- drive_ls(as_id("1C1nq47Q8fnMRaVa1wMeZb1ZIpIRl-Pt0")) %>%
filter(str_detect(name, "2024")) %>%
pull(id)
id_ntee_to_movements <- drive_ls(as_id("1p25pJ15lMJUhtlGQCbb8ADo8vuUueM5J")) %>%
filter(name == "ntee_to_movements_class") %>%
pull(id)
id_training_data <- drive_ls(drive_out) %>%
filter(name == "movements_training_data") %>%
pull(id)
stopifnot(length(id_orgs_w_ntee) == 1,
length(id_mision) == 1,
length(id_ntee_to_movements) == 1,
length(id_training_data) == 1)
# READ DATA ====
# Orgs w/ NTEE classification
drive_download(as_id(id_orgs_w_ntee),
path = paste0(tempdir(), "/orgs_w_ntee_2024.csv"),
overwrite = TRUE)
orgs_w_ntee <- read_csv(paste0(tempdir(), "/orgs_w_ntee_2024.csv"))
file.remove(paste0(tempdir(), "/orgs_w_ntee_2024.csv"))
# Misiones
drive_download(as_id(id_mision),
path = paste0(tempdir(), "/misiones_2024.xlsx"),
overwrite = TRUE)
misiones <- read_excel(paste0(tempdir(), "/misiones_2024.xlsx"),
sheet = "Generales") %>%
clean_names() %>%
mutate(across(.cols = everything(),
.fns = ~ ifelse(.x == "", NA, .x))) %>%
select(rfc, razon_social, mision, valores)
file.remove(paste0(tempdir(), "/misiones_2024.xlsx"))
# NTEE to movements
drive_download(as_id(id_ntee_to_movements),
path = paste0(tempdir(), "/ntee_to_movements_2024.csv"),
overwrite = TRUE)
ntee_to_movements <- read_csv(paste0(tempdir(), "/ntee_to_movements_2024.csv")) %>%
select(ntee_code:second_classification)
file.remove(paste0(tempdir(), "/ntee_to_movements_2024.csv"))
# Training data
drive_download(as_id(id_training_data),
path = paste0(tempdir(), "/movements_training_data.csv"),
overwrite = TRUE)
movements_training_data <- read_csv(paste0(tempdir(), "/movements_training_data.csv"))
rm(movements_training_data)
training_data_rfc <- read_csv(paste0(tempdir(), "/movements_training_data.csv"))
file.remove(paste0(tempdir(), "/movements_training_data.csv"))
# JOIN DATA ====
orgs_w_second_classification <- orgs_w_ntee %>%
left_join(ntee_to_movements, by = c("ntee" = "ntee_code")) %>%
left_join(misiones, by = "rfc") %>%
relocate(c(razon_social, mision, valores), .after = rfc) %>%
select(rfc:valores, ntee, second_classification)
non_movements <- orgs_w_second_classification %>%
filter(second_classification != "Clasificar movimiento")
movements_to_classify_pre <- orgs_w_second_classification %>%
filter(second_classification == "Clasificar movimiento",
!is.na(mision)) %>%
select(-second_classification)
# Training data
drive_download(as_id(id_training_data),
path = paste0(tempdir(), "/movements_training_data.csv"),
overwrite = TRUE)
training_data_rfc <- read_csv(paste0(tempdir(), "/movements_training_data.csv")) %>%
pull(rfc)
file.remove(paste0(tempdir(), "/movements_training_data.csv"))
movements_to_classify <- movements_to_classify_pre %>%
filter(!rfc %in% training_data_rfc)
stopifnot(nrow(movements_to_classify) + length(training_data_rfc) == nrow(movements_to_classify_pre))
# EXPORT DATA ====
# Non movements
write_csv(non_movements,
paste0(paths$output, "non_movements.csv"))
drive_upload(paste0(paths$output, "non_movements.csv"),
path = drive_out,
overwrite = TRUE)
file.remove(paste0(paths$output, "non_movements.csv"))
# To be classified
# Divide movements_to_classify into n parts and save each part
n <- 6
chunk_size <- trunc(nrow(movements_to_classify) / n)
for (i in 1:n){
start_row <- ((i - 1) * chunk_size) + 1
end_row <- ifelse(i == n, nrow(movements_to_classify), i * chunk_size)
movements_to_classify_part <- movements_to_classify %>%
slice(start_row:end_row)
stopifnot(nrow(movements_to_classify_part) >= chunk_size)
write_csv(movements_to_classify_part,
paste0(paths$output, "movements_to_classify_part_", i, ".csv"))
drive_upload(paste0(paths$output, "movements_to_classify_part_", i, ".csv"),
path = drive_out,
overwrite = TRUE)
file.remove(paste0(paths$output, "movements_to_classify_part_", i, ".csv"))
}
# To be classified
# Divide movements_to_classify into n parts and save each part
n <- 10
chunk_size <- trunc(nrow(movements_to_classify) / n)
for (i in 1:n){
start_row <- ((i - 1) * chunk_size) + 1
end_row <- ifelse(i == n, nrow(movements_to_classify), i * chunk_size)
movements_to_classify_part <- movements_to_classify %>%
slice(start_row:end_row)
stopifnot(nrow(movements_to_classify_part) >= chunk_size)
write_csv(movements_to_classify_part,
paste0(paths$output, "movements_to_classify_part_", i, ".csv"))
drive_upload(paste0(paths$output, "movements_to_classify_part_", i, ".csv"),
path = drive_out,
overwrite = TRUE)
file.remove(paste0(paths$output, "movements_to_classify_part_", i, ".csv"))
}
i <- 2
# JOIN DATA ====
orgs_w_second_classification <- orgs_w_ntee %>%
left_join(ntee_to_movements, by = c("ntee" = "ntee_code")) %>%
left_join(misiones, by = "rfc") %>%
relocate(c(razon_social, mision, valores), .after = rfc) %>%
select(rfc:valores, ntee, second_classification) %>%
distinct()
non_movements <- orgs_w_second_classification %>%
filter(second_classification != "Clasificar movimiento")
movements_to_classify_pre <- orgs_w_second_classification %>%
filter(second_classification == "Clasificar movimiento",
!is.na(mision)) %>%
select(-second_classification)
orgs_w_second_classification <- orgs_w_ntee %>%
left_join(ntee_to_movements, by = c("ntee" = "ntee_code")) %>%
left_join(misiones, by = "rfc") %>%
relocate(c(razon_social, mision, valores), .after = rfc) %>%
select(rfc:valores, ntee, second_classification)
orgs_w_second_classification <- orgs_w_ntee %>%
left_join(ntee_to_movements, by = c("ntee" = "ntee_code")) %>%
left_join(misiones, by = "rfc") %>%
relocate(c(razon_social, mision, valores), .after = rfc) %>%
select(rfc:valores, ntee, second_classification) %>%
distinct()
non_movements <- orgs_w_second_classification %>%
filter(second_classification != "Clasificar movimiento")
movements_to_classify_pre <- orgs_w_second_classification %>%
filter(second_classification == "Clasificar movimiento",
!is.na(mision)) %>%
select(-second_classification)
movements_to_classify <- movements_to_classify_pre %>%
filter(!rfc %in% training_data_rfc)
stopifnot(nrow(movements_to_classify) + length(training_data_rfc) == nrow(movements_to_classify_pre))
# EXPORT DATA ====
# Non movements
write_csv(non_movements,
paste0(paths$output, "non_movements.csv"))
drive_upload(paste0(paths$output, "non_movements.csv"),
path = drive_out,
overwrite = TRUE)
file.remove(paste0(paths$output, "non_movements.csv"))
# To be classified
# Divide movements_to_classify into n parts and save each part
n <- 10
chunk_size <- trunc(nrow(movements_to_classify) / n)
for (i in 1:n){
start_row <- ((i - 1) * chunk_size) + 1
end_row <- ifelse(i == n, nrow(movements_to_classify), i * chunk_size)
movements_to_classify_part <- movements_to_classify %>%
slice(start_row:end_row)
stopifnot(nrow(movements_to_classify_part) >= chunk_size)
write_csv(movements_to_classify_part,
paste0(paths$output, "movements_to_classify_part_", i, ".csv"))
drive_upload(paste0(paths$output, "movements_to_classify_part_", i, ".csv"),
path = drive_out,
overwrite = TRUE)
file.remove(paste0(paths$output, "movements_to_classify_part_", i, ".csv"))
}
test <- readRDS("/Users/sierra/Library/Containers/Mattermost.Desktop/Data/tmp/base-estatal (1).RDS"")
test <- readRDS("/Users/sierra/Library/Containers/Mattermost.Desktop/Data/tmp/base-estatal (1).RDS")
View(test)
test <- readRDS("/Users/sierra/Library/Containers/Mattermost.Desktop/Data/tmp/base-estatal (1).RDS")
michoacan <- test %>%
filter(nivel == "Estatal",
entidad_federativa == "Michoacán")
View(michoacan)
michoacan <- test %>%
filter(nivel == "Estatal",
entidad_federativa == "Michoacán",
dummy_gpos_discriminados)
View(michoacan)
michoacan <- test %>%
filter(nivel == "Estatal",
entidad_federativa == "Michoacán",
dummy_gpos_discriminados == 1)
michoacan <- test %>%
filter(nivel == "Estatal",
entidad_federativa == "Michoacán",
dummy_gpos_discriminados == 1) %>%
group_by(grupo_de_atencion) %>%
count()
View(michoacan)
michoacan <- test %>%
filter(nivel == "Estatal",
entidad_federativa == "Michoacán",
dummy_gpos_discriminados == 1)
View(michoacan)
michoacan <- test %>%
filter(nivel == "Estatal",
entidad_federativa == "Michoacán",
dummy_gpos_discriminados == 1) %>%
group_by(categoria_grupo_de_atencion) %>%
count()
View(michoacan)
michoacan <- test %>%
filter(nivel == "Estatal",
entidad_federativa == "Michoacán",
dummy_gpos_discriminados == 1)
View(michoacan)
michoacan <- test %>%
filter(nivel == "Estatal",
entidad_federativa == "Michoacán",
dummy_gpos_discriminados == 1) %>%
group_by(categoria_grupo_de_atencion) %>%
summarize(count = length(unique(id_programa)))
View(michoacan)
michoacan <- test %>%
filter(nivel == "Estatal",
entidad_federativa == "Michoacán",
dummy_gpos_discriminados == 1)
length(unique(michoacan$id_programa))
michoacan <- test %>%
filter(nivel == "Estatal",
entidad_federativa == "Michoacán",
dummy_gpos_discriminados == 1) %>%
group_by(categoria_grupo_de_atencion) %>%
summarize(count = length(unique(id_programa)))
View(michoacan)
table(test$derecho_social)
michoacan <- test %>%
filter(nivel == "Estatal",
entidad_federativa == "Michoacán",
dummy_gpos_discriminados == 1,
derecho_social == "Salud") %>%
group_by(categoria_grupo_de_atencion) %>%
summarize(count = length(unique(id_programa)))
View(michoacan)
